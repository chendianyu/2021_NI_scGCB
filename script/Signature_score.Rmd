---
title: "Calculate signature score"
author: "Dianyu Chen"
date: "2021/4/6"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this vignette, we show how to calculate signature score based on gene list.  
Firstly, load the packages needed and Seurat object.  
```{r, message=FALSE, warning=FALSE}
library(Seurat)
library(tidyverse)
library(ggbeeswarm)

gcb_np_integrated_clean <- readRDS("../data/gcb_np_integrated_clean.RDS")
```

Then we define the function to calculate signature score. Great thanks to **Adam Hamber** from Broad Institute and **Itay Tirosh** from Weizmann Institute for sharing the concept and code.  
```{r}
## The code below is from Adam Hamber
## 2D scoring by Itay
get_controls <- function(counts, gene.list, verbose=F, control.genes.per.gene=10)
{
    # Itay: "Such scores are inevitably correlated with cell complexity so to avoid 
    # that I subtract a "control" score which is generated by averaging over a control 
    # gene set. Control gene sets are chosen to contain 100 times more genes than the 
    # real gene set (analogous to averaging over 100 control sets of similar size) and 
    # to have the same distribution of population/bulk - based expression levels as the 
    # real gene set, such that they are expected to have the same number of "zeros" and 
    # to eliminate the correlation with complexity."
    # ---------------------------------------------------------------------------------
    # Going to find control points by finding the closest genes in terms of expression level and % of the time we observe it
    if(verbose){cat(sprintf("Finding %s background genes based on similarity to given gene set [%s genes] \n", 
                            control.genes.per.gene*length(gene.list), length(gene.list)))}
    cat("Summarizing data \n")
    summary = data.frame(gene=row.names(counts), mean.expr = Matrix::rowMeans(counts), fract.zero = Matrix::rowMeans(counts==0), stringsAsFactors = F)
    #summary = data.frame(gene=row.names(counts), mean.expr = apply(counts,1,mean), fract.zero = apply(counts==0,1,mean), stringsAsFactors = F)
    summary$mean.expr.s = scale(summary$mean.expr)
    summary$fract.zero.s = scale(summary$fract.zero)
    actual.genes = summary[summary$gene %in% gene.list,]
    background.genes = summary[!summary$gene %in% gene.list,]
    
    #find the 10 closest genes to each cell cycle marker gene and add them to the lists of control genes
    get_closest_genes <- function(i)
    {
        background.genes$dist = sqrt((background.genes$mean.expr.s - actual.genes$mean.expr.s[i])^2 + 
                                         (background.genes$fract.zero.s - actual.genes$fract.zero.s[i])^2)
        ordered = background.genes$gene[order(background.genes$dist)]
        ordered = ordered[!ordered %in% controls] # don't take genes that already appear in the list 
        closest = head(ordered, n=control.genes.per.gene)
        return(closest)
    }
    controls = c();
    
    for (i in 1:length(gene.list)){
        #info(sprintf("Finding %s control genes for %s", control.genes.per.gene, gene.list[i]))
        closest = get_closest_genes(i)
        #info(sprintf("Found %s: ", length(closest)))
        controls = unique(c(controls, closest))
    }
    
    if(verbose){cat(sprintf("Control gene selection complete. %s genes found. \n", length(controls)))}
    #print(controls)
    return(controls)
}
```
```{r}
## Define calculate function
calculate_signature_score <- function(count_matrix, gene_list){
    control_gene <- get_controls(counts = count_matrix,
                                 gene.list = gene_list)
    signature_score <- colMeans(count_matrix[gene_list, ], na.rm = TRUE) - 
        colMeans(count_matrix[control_gene, ], na.rm = TRUE)
    return(signature_score)
}  
```
  
Count matrix for signature score calculation is normalized data of Seurat object.
```{r}
## normalized count matrix
normalized_matrix <- as.data.frame(gcb_np_integrated_clean[['RNA']]@data)
```

Now we can calculate signature score for each gene list.  

## Cell cycle  
* G1S  
```{r}
g1s_gene <- read.csv("../signature_gene/G1S_gene.csv", 
                     stringsAsFactors = FALSE)
g1s_gene <- g1s_gene$Gene
g1s_score <- calculate_signature_score(normalized_matrix, g1s_gene)
gcb_np_integrated_clean <- AddMetaData(gcb_np_integrated_clean,
                                       g1s_score,
                                       "g1s_score")

## violin plot
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(seurat_clusters, g1s_score, color = seurat_clusters)) +
    geom_violin(draw_quantiles=c(0.25,0.75),trim = FALSE) +
    geom_quasirandom(size = 0.01, width = 0.2, alpha = 0.3) +
    stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black") +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA))

## Compare difference between clusters
fit <- aov(g1s_score ~ seurat_clusters, gcb_np_integrated_clean@meta.data)
TukeyHSD(fit)
```
  
* G2M
```{r}
g2m_gene <- read.csv("../signature_gene/G2M_gene.csv", 
                     stringsAsFactors = FALSE)
g2m_gene <- g2m_gene$Gene
g2m_score <- calculate_signature_score(normalized_matrix, g2m_gene)
gcb_np_integrated_clean <- AddMetaData(gcb_np_integrated_clean,
                                       g2m_score,
                                       "g2m_score")

## violin plot
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(seurat_clusters, g2m_score, color = seurat_clusters)) +
    geom_violin(draw_quantiles=c(0.25,0.75),trim = FALSE) +
    geom_quasirandom(size = 0.01, width = 0.2, alpha = 0.3) +
    stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black") +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA))

## Compare difference between clusters
fit <- aov(g2m_score ~ seurat_clusters, gcb_np_integrated_clean@meta.data)
TukeyHSD(fit)
```
  
* Point plot for cell cycle
```{r}
## cell cycle
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(g1s_score, g2m_score, color = seurat_clusters)) +
    geom_point(size = 0.01, show.legend = FALSE) +
    facet_wrap(~seurat_clusters, nrow = 1) +
    lims(x=c(-0.45, 1.3), y=c(-0.45, 1.3)) +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA)) +
    xlab("G1/S phase") +
    ylab("G2/M phase") +
    coord_equal(ratio = 1)
```
  
## Zone
* Light Zone
```{r}
lz_gene <- read.csv("../signature_gene/LZ_gene.csv", 
                     stringsAsFactors = FALSE)
lz_gene <- lz_gene$Gene
lz_score <- calculate_signature_score(normalized_matrix, lz_gene)
gcb_np_integrated_clean <- AddMetaData(gcb_np_integrated_clean,
                                       lz_score,
                                       "lz_score")

## violin plot
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(seurat_clusters, lz_score, color = seurat_clusters)) +
    geom_violin(draw_quantiles=c(0.25,0.75),trim = FALSE) +
    geom_quasirandom(size = 0.01, width = 0.2, alpha = 0.3) +
    stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black") +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA))

## Compare difference between clusters
fit <- aov(lz_score ~ seurat_clusters, gcb_np_integrated_clean@meta.data)
TukeyHSD(fit)
```

* Dark Zone
```{r}
dz_gene <- read.csv("../signature_gene/DZ_gene.csv", 
                     stringsAsFactors = FALSE)
dz_gene <- dz_gene$Gene
dz_score <- calculate_signature_score(normalized_matrix, dz_gene)
gcb_np_integrated_clean <- AddMetaData(gcb_np_integrated_clean,
                                       dz_score,
                                       "dz_score")

## violin plot
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(seurat_clusters, dz_score, color = seurat_clusters)) +
    geom_violin(draw_quantiles=c(0.25,0.75),trim = FALSE) +
    geom_quasirandom(size = 0.01, width = 0.2, alpha = 0.3) +
    stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black") +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA))

## Compare difference between clusters
fit <- aov(dz_score ~ seurat_clusters, gcb_np_integrated_clean@meta.data)
TukeyHSD(fit)
```

* Point plot for zone
```{r}
## Zone
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(lz_score, dz_score, color = seurat_clusters)) +
    geom_point(size = 0.01, show.legend = FALSE) +
    facet_wrap(~seurat_clusters, nrow = 1) +
    lims(x=c(-0.3, 1), y=c(-0.3, 1)) +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA)) +
    xlab("Light Zone (LZ)") +
    ylab("Dark Zone (DZ)") +
    coord_equal(ratio = 1)
```
  
* Correlation plot for LZ and DZ
```{r}
gcb_np_integrated_clean@meta.data %>% 
    group_by(seurat_clusters) %>% 
    summarise(lz_score = mean(lz_score),
              dz_score = mean(dz_score)) %>% 
    ggplot(aes(lz_score, dz_score, color = seurat_clusters)) +
    geom_point() +
    geom_text(aes(label = seurat_clusters), nudge_x = 0.01) + 
    lims(x=c(-0.1, 0.2), y=c(-0.1, 0.4)) +
    theme_classic()
```

* Gray Zone ([*Domenick EK, et al., Nat Immunol, 2020*](https://pubmed.ncbi.nlm.nih.gov/32341509/))
```{r}
gz_gene <- read.csv("../signature_gene/GZ_gene.csv", 
                     stringsAsFactors = FALSE)
gz_gene <- gz_gene$Gene
gz_score <- calculate_signature_score(normalized_matrix, gz_gene)
gcb_np_integrated_clean <- AddMetaData(gcb_np_integrated_clean,
                                       gz_score,
                                       "gz_score")

## violin plot
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(seurat_clusters, gz_score, color = seurat_clusters)) +
    geom_violin(draw_quantiles=c(0.25,0.75),trim = FALSE) +
    geom_quasirandom(size = 0.01, width = 0.2, alpha = 0.3) +
    stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black") +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA))

## Compare difference between clusters
fit <- aov(gz_score ~ seurat_clusters, gcb_np_integrated_clean@meta.data)
TukeyHSD(fit)
```
  
## Metabolic pathway
* Oxidative phosphorylation (GO: 0006119)
```{r}
oxp_gene <- read.csv("../signature_gene/Oxp_gene.csv", 
                     stringsAsFactors = FALSE)
oxp_gene <- oxp_gene$Gene
oxp_score <- calculate_signature_score(normalized_matrix, oxp_gene)
gcb_np_integrated_clean <- AddMetaData(gcb_np_integrated_clean,
                                       oxp_score,
                                       "oxp_score")

## violin plot
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(seurat_clusters, oxp_score, color = seurat_clusters)) +
    geom_violin(draw_quantiles=c(0.25,0.75),trim = FALSE) +
    geom_quasirandom(size = 0.01, width = 0.2, alpha = 0.3) +
    stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black") +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA))

## Compare difference between clusters
fit <- aov(oxp_score ~ seurat_clusters, gcb_np_integrated_clean@meta.data)
TukeyHSD(fit)
```
  
* Glycolysis (PW:0000640, [*Florian JW, et al., Nat Immunol, 2020*](https://pubmed.ncbi.nlm.nih.gov/32066950/))
```{r}
glycolysis_gene <- read.csv("../signature_gene/Glycolysis_gene.csv", 
                     stringsAsFactors = FALSE)
glycolysis_gene <- glycolysis_gene$Gene
glycolysis_score <- calculate_signature_score(normalized_matrix, glycolysis_gene)
gcb_np_integrated_clean <- AddMetaData(gcb_np_integrated_clean,
                                       glycolysis_score,
                                       "glycolysis_score")

## violin plot
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(seurat_clusters, glycolysis_score, color = seurat_clusters)) +
    geom_violin(draw_quantiles=c(0.25,0.75),trim = FALSE) +
    geom_quasirandom(size = 0.01, width = 0.2, alpha = 0.3) +
    stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black") +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA))

## Compare difference between clusters
fit <- aov(glycolysis_score ~ seurat_clusters, gcb_np_integrated_clean@meta.data)
TukeyHSD(fit)
```
  
* Fatty acid beta oxidation (GO: 0006635)
```{r}
fatty_acid_beta_oxidation_gene <- read.csv("../signature_gene/Fatty_acid_beta_oxidation_gene.csv", 
                     stringsAsFactors = FALSE)
fatty_acid_beta_oxidation_gene <- fatty_acid_beta_oxidation_gene$Gene
fatty_acid_beta_oxidation_score <- calculate_signature_score(normalized_matrix, fatty_acid_beta_oxidation_gene)
gcb_np_integrated_clean <- AddMetaData(gcb_np_integrated_clean,
                                       fatty_acid_beta_oxidation_score,
                                       "fatty_acid_beta_oxidation_score")

## violin plot
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(seurat_clusters, fatty_acid_beta_oxidation_score, color = seurat_clusters)) +
    geom_violin(draw_quantiles=c(0.25,0.75),trim = FALSE) +
    geom_quasirandom(size = 0.01, width = 0.2, alpha = 0.3) +
    stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black") +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA))

## Compare difference between clusters
fit <- aov(fatty_acid_beta_oxidation_score ~ seurat_clusters, gcb_np_integrated_clean@meta.data)
TukeyHSD(fit)
```
  
* Ribosome biogenesis (GO: 0042254)
```{r}
ribosome_biogenesis_gene <- read.csv("../signature_gene/Ribosome_biogenesis_gene.csv", 
                     stringsAsFactors = FALSE)
ribosome_biogenesis_gene <- ribosome_biogenesis_gene$Gene
ribosome_biogenesis_score <- calculate_signature_score(normalized_matrix, ribosome_biogenesis_gene)
gcb_np_integrated_clean <- AddMetaData(gcb_np_integrated_clean,
                                       ribosome_biogenesis_score,
                                       "ribosome_biogenesis_score")

## violin plot
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(seurat_clusters, ribosome_biogenesis_score, color = seurat_clusters)) +
    geom_violin(draw_quantiles=c(0.25,0.75),trim = FALSE) +
    geom_quasirandom(size = 0.01, width = 0.2, alpha = 0.3) +
    stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black") +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA))

## Compare difference between clusters
fit <- aov(ribosome_biogenesis_score ~ seurat_clusters, gcb_np_integrated_clean@meta.data)
TukeyHSD(fit)
```
  
## Other pathway
* MYC up-regulated (MSigDB)
```{r}
myc_up_gene <- read.csv("../signature_gene/Myc_up_gene.csv", 
                     stringsAsFactors = FALSE)
myc_up_gene <- myc_up_gene$Gene
myc_up_score <- calculate_signature_score(normalized_matrix, myc_up_gene)
gcb_np_integrated_clean <- AddMetaData(gcb_np_integrated_clean,
                                       myc_up_score,
                                       "myc_up_score")

## violin plot
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(seurat_clusters, myc_up_score, color = seurat_clusters)) +
    geom_violin(draw_quantiles=c(0.25,0.75),trim = FALSE) +
    geom_quasirandom(size = 0.01, width = 0.2, alpha = 0.3) +
    stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black") +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA))

## Compare difference between clusters
fit <- aov(myc_up_score ~ seurat_clusters, gcb_np_integrated_clean@meta.data)
TukeyHSD(fit)
```

* CD40 up-regulated 
```{r}
cd40_up_gene <- read.csv("../signature_gene/CD40_up_gene.csv", 
                     stringsAsFactors = FALSE)
cd40_up_gene <- cd40_up_gene$Gene
cd40_up_score <- calculate_signature_score(normalized_matrix, cd40_up_gene)
gcb_np_integrated_clean <- AddMetaData(gcb_np_integrated_clean,
                                       cd40_up_score,
                                       "cd40_up_score")

## violin plot
gcb_np_integrated_clean@meta.data %>%
    ggplot(aes(seurat_clusters, cd40_up_score, color = seurat_clusters)) +
    geom_violin(draw_quantiles=c(0.25,0.75),trim = FALSE) +
    geom_quasirandom(size = 0.01, width = 0.2, alpha = 0.3) +
    stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black") +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          panel.border = element_rect(fill = NA))

## Compare difference between clusters
fit <- aov(cd40_up_score ~ seurat_clusters, gcb_np_integrated_clean@meta.data)
TukeyHSD(fit)
```

## Session info
```{r}
sessionInfo()
```